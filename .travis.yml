#
# k2hftfuse for file transaction by FUSE-based file system
#
# Copyright 2015 Yahoo Japan Corporation.
#
# k2hftfuse is file transaction system on FUSE file system with
# K2HASH and K2HASH TRANSACTION PLUGIN, CHMPX.
#
# For the full copyright and license information, please view
# the license file that was distributed with this source code.
#
# AUTHOR:   Takeshi Nakatani
# CREATE:   Tue Sep 1 2015
# REVISION:
#

language: cpp

sudo: required

dist: trusty

env:
  global:
    - PCUSER=antpickax
    - PCREPO=current
    - PCDLREPO=stable
  matrix:
    - OS=centos 
      TAG=centos7 
      DISTTAG=el/7 
      INSTPKG="git autoconf automake gcc gcc-c++ gdb make libtool pkgconfig redhat-rpm-config rpm-build ruby-devel rubygems libyaml-devel fuse fuse-devel k2htpdtor chmpx-devel"
    - OS=centos 
      TAG=centos6 
      DISTTAG=el/6 
      INSTPKG="git autoconf automake gcc gcc-c++ gdb make libtool pkgconfig redhat-rpm-config rpm-build ruby-devel rubygems libyaml-devel fuse fuse-devel k2htpdtor chmpx-devel"
    - OS=fedora 
      TAG=28 
      DISTTAG=fedora/28 
      INSTPKG="git autoconf automake gcc gcc-c++ gdb make libtool pkgconfig redhat-rpm-config rpm-build ruby-devel rubygems libyaml-devel fuse fuse-devel k2htpdtor chmpx-devel"
    - OS=ubuntu 
      TAG=18.04 
      DISTTAG=ubuntu/bionic 
      INSTPKG="git autoconf autotools-dev gcc g++ make gdb dh-make fakeroot dpkg-dev devscripts libtool pkg-config ruby-dev rubygems rubygems-integration libyaml-dev fuse libfuse-dev k2htpdtor chmpx-dev"
    - OS=debian 
      TAG=stretch 
      DISTTAG=debian/stretch 
      INSTPKG="git autoconf autotools-dev gcc g++ make gdb dh-make fakeroot dpkg-dev devscripts libtool pkg-config ruby-dev rubygems rubygems-integration libyaml-dev fuse libfuse-dev k2htpdtor chmpx-dev"

cache: apt

services:
  - docker

before_install:
  - sudo apt-get update -qq
  - echo 'DOCKER_OPTS="-H tcp://127.0.0.1:2375 -H unix:///var/run/docker.sock -s devicemapper"' | sudo tee /etc/default/docker > /dev/null
  - sudo service docker restart
  - sleep 5
  - sudo docker image pull ${OS}:${TAG}

script:
  - 'if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then export PCTOKEN=dummy_token_for_pr; else export PCTOKEN=${PACKAGECLOUD_TOKEN}; fi'
  - sudo docker container run 
    --rm=true 
    --cap-add MKNOD 
    --cap-add SYS_ADMIN 
    --device /dev/fuse 
    --security-opt apparmor:unconfined 
    --privileged 
    -e TRAVIS_TAG=${TRAVIS_TAG} 
    -e FORCE_BUILD_PKG=${FORCE_BUILD_PKG} 
    -e USE_PC_REPO=${USE_PC_REPO} 
    -e BUILD_NUMBER=${BUILD_NUMBER} 
    -e DEBFULLNAME=${DEBFULLNAME} 
    -e DEBEMAIL=${DEBEMAIL} 
    -e CONFIGREOPT=${CONFIGREOPT} 
    -e K2HATTR_ENC_TYPE=${K2HATTR_ENC_TYPE} 
    -v `pwd`:/k2hftfuse:rw ${OS}:${TAG} 
    /bin/sh -c "/k2hftfuse/buildutils/travis_builder.sh -${OS} -pctoken ${PCTOKEN} -pcuser ${PCUSER} -pcrepo ${PCREPO} -pcdlrepo ${PCDLREPO} -pcdist ${DISTTAG} ${INSTPKG}"

#
# VIM modelines
#
# vim:set ts=4 fenc=utf-8:
#
